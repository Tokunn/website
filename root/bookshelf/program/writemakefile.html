<?php include_once("/srv/http/website/root/common/template/template.php"); ?>
<?php set_head(__FILE__); ?>

<div id="pageBodyMain">
    <article>
        <header class="articleDetailHead">
            <h1 class="pageTitle">Makefileの書き方</h1>
        </header>

        <section class="articleDetailBody" id="body">

            <div id="objective">
                <h2 class="heading-typeA">目的</h2>
                <p>C++やCなどコンパイラ型言語を使ってプログラミングをするときは、何度も何度もコンパイルを繰り返します。
                ここで、今RaspberryPi(ARM Linuxボード)を使ってプログラムを作成しているとします。
                プログラムをホストマシンで組み、クロスコンパイルして実行ファイルをRaspberryPiへと転送します。
                このとき、作業では次のコマンドを打ち込みます。
                <pre class="brush: bash;">
                    gcc-linaro-arm-linux-gnueabihf-g++ -Wall -Wextra -O2 -g -MMD -MP -L/usr/local/lib -I../include -I/usr/local/include -o cmd
                    scp cmd user@192.168.7.2:/usr/bin/
                </pre>
                <p>これだけを見ると「たったの２行？」と感じるかもしれませんが、コンパイルして実行するたびにこのコマンドを何度も何度も打ち込むのはとても大変で非効率的です。
                1回で160文字、10回繰り返すと1600文字、30回繰り返すと4800文字、これだけあれば、ソースコード100行分は優に超える文字数になります。
                この無駄な時間を減らすためにあるのが、今回のテーマmakeです。</p>
                <p>間違いを恐れずにmakeを大雑把にいうと、シェルスクリプトのコンパイル特化版です。
                また、大規模で分割されたプログラムなどで、必要なものだけコンパイルするため高速化を図れます。</p>
                <p>では、makeを使うとどのくらい短縮できるのでしょうか？
                答えは次のコマンドが表していますね。
                makeを使った時に、先ほどと同じ操作をするために打つコマンドです。</p>
                <pre class="brush: bash;">
                    make
                </pre>
                <p>「えっ？これだけ？」と思うかもしれません。
                その通りです。
                makeを使うとこれだけで、コンパイルから転送までが済んでしまいます。
                あんな長ったらしいコマンドとはもうおさらばです。</p>
                <p>ただし最初からmakeと打つだけでできるわけではありません。
                makeを使うためには、コンパイルの設定を書き込んだMakefileが必要になります。
                Makefileはその名の通りmakeのファイルで、コンパイラの情報からオプション・依存関係まで、様々なものを書き込んでおくのですが、これがなかなか慣れない書き方をしなければなりません。
                今回は、このMakefileを書いて作業の効率を上げる方法を解説していきます。</p>
            </div><!-- objective -->

            <div id="methods">
                <h2 class="heading-typeA">方法</h2>
                <p>では、ここからはMakefileの書き方です。</p>
                <div id="provide">
                    <h3 class="heading-typeB">準備</h3>
                    <p>まずは、makeをインストールしてください。</p>
                    <pre class="brush: bash;">
                        # ArchLinux
                        $ sudo pacman -S make

                        # Ubuntu Debian系
                        $ sudo apt-get install make

                        # Fedora Redhat系
                        $ sudo yum -y install make
                    </pre>
                    <p>今回はArchLinuxでC++を使って解説しますが、LinuxならUbuntuでもFedoraでも基本的な操作は変わりません。</p>
                    <p>次に、普段コンパイルに使用しているコマンドを用意してください。
                    今回は先ほど上げた2行のコマンドとします。</p>
                    <p>オプションなどについては別の回で解説します。</p>
                </div><!-- provide -->

                <div id="write">
                    <h3 class="heading-typeB">書き方</h3>
                    <div id="makefile">
                        <p>まずは、先に完成したMakefileです。
                        ファイルは<a href="/bookshelf/program/Makefile">こちら</a>。</p>
                        <pre class="brush: bash;">
                            CROSS   := ~/Program/cross_gcc/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin/arm-linux-gnueabihf

                            ifneq ($(CROSS),)
                                CROSS_PREFIX	:= $(CROSS)-
                            endif

                            CXX		 = $(CROSS_PREFIX)g++
                            CXXFLAGS = -Wall -Wextra -O2 -g -MMD -MP
                            LDFLAGS	 =
                            LIBS	 = -L/usr/local/lib
                            INCLUDE	 = -I../include -I/usr/local/include
                            BIN_DIR  = ../bin/
                            TARGET 	 = $(BIN_DIR)$(shell basename `readlink -f ..`)
                            OBJDIR	 = ./obj
                            ifeq "$(strip $(OBJDIR))" ""
                                OBJDIR = .
                            endif
                            SOURCES	:= $(wildcard *.cpp)
                            OBJECTS	 = $(addprefix $(OBJDIR)/,$(SOURCES:.cpp=.o))
                            DEPENDS	 = $(OBJECTS:.o=.d)

                            all: $(BIN_DIR) $(TARGET)

                            $(TARGET): $(OBJECTS)
                                $(CXX) -o $@ $^ $(LDFLAGS)

                            $(OBJDIR)/%.o:%.cpp
                                @[ -d $(OBJDIR) ] || mkdir -p $(OBJDIR)
                                $(CXX) $(CXXFLAGS) $(INCLUDE) -o $@ -c $<

                            $(BIN_DIR):
                                mkdir -p $(BIN_DIR)

                            clean:
                                $(RM) -r $(OBJECTS) $(DEPENDS) $(TARGET) $(BIN_DIR) `readlink -f $(OBJDIR)`

                            upload: $(BIN_DIR) $(TARGET)
                                scp $(TARGET) root@192.168.7.2:/usr/bin/


                            -include $(DEPENDS)
                        </pre>
                        <p>20行目までが、変数などの定義、22行目からがコンパイルなどの操作をしています。</p>
                    </div><!-- makefile -->
                    <div id="variable">
                        <table>
                            <caption>変数</caption>
                            <tr>
                                <th>変数名</th>
                                <th>役割</th>
                            </tr>
                            <tr>
                                <td>CROSS</td>
                                <td>クロスコンパイラへのパス（最後の"-gcc" "-g++"は除いて代入）</td>
                            </tr>
                            <tr>
                                <td>CXX</td>
                                <td>コンパイラの名前（"$(CROSS)-g++"が代入される。CROSSが空の場合は"g++"のみ）</td>
                            </tr>
                            <tr>
                                <td>CXXFLAGS</td>
                                <td>コンパイルオプション（複数の場合はスペース区切りで列挙）</td>
                            </tr>
                            <tr>
                                <td>LDFLAGS</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>LIBS</td>
                                <td>ライブラリへのパス</td>
                            </tr>
                            <tr>
                                <td>INCLUDE</td>
                                <td>インクルードするファイルへのパス</td>
                            </tr>
                            <tr>
                                <td>BIN_DIR</td>
                                <td>作成する実行ファイルを保存するフォルダ名</td>
                            </tr>
                            <tr>
                                <td>TARGET</td>
                                <td>作成する実行ファイルの名前（今回は上の階層のディレクトリ名を取得）</td>
                            </tr>
                            <tr>
                                <td>OBJDIR</td>
                                <td>コンパイル・リンク中に生成されるファイルの一時保存場所</td>
                            </tr>
                            <tr>
                                <td>SOURCES</td>
                                <td>コンパイルするソースファイル名（今回は .cppのファイル）</td>
                            </tr>
                            <tr>
                                <td>OBJECTS</td>
                                <td>コンパイル・リンクで生成されるファイル名</td>
                            </tr>
                            <tr>
                                <td>DEPENDS</td>
                                <td></td>
                            </tr>
                        </table>
                    </div><!-- variable -->
                    <div id="operation">
                    </div><!-- operation -->

                </div><!-- write -->

            </div><!-- methods -->

        </section><!-- body -->

        <footer class="articleDetailFoot">
            <section id="body">
                <h2 class="heading-typeC">参考サイト</h2>
                <ul>
                    <li><a href="http://www.example.com/">example.com</a></li>
                </ul>
            </section><!-- body -->
        </footer>
    </article>
</div><!-- pageBodyMain -->

<div id="pageBodySub">
    <nav class="localNavi">
        <dl>
            <dt>目次</dt>
            <dd><a href="#objective">目的</a></dd>
            <dd>
                <a href="#methods">方法</a>
                <ol>
                    <li><a href="#provide">準備</a></li>
                    <li><a href="#write">書き方</a></li>
                    <ul>
                        <li><a href="#makefile">ファイル</a></li>
                        <li><a href="#variable">変数</a></li>
                        <li><a href="#operation">操作</a></li>
                    </ul>
                </ol>
            </dd>
        </dl>
    </nav>
</div><!-- pageBodySub -->

<?php set_foot(); ?>
